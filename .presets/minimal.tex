\usepackage[dvipsnames, table]{xcolor}

\usepackage{setspace}
\onehalfspacing

\usepackage{csquotes}

% ----------------------------------------------------------------------------
% Math
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{mathtools}

\newcommand{\opn}[1]{\operatorname{#1}}

\newcommand{\R}{\mathbb{R}}
\newcommand{\Z}{\mathbb{Z}}

\newcommand{\e}{\mathrm{e}}
\newcommand{\ii}{\mathrm{i}}
\newcommand{\ppi}{\mathrm{\pi}}

\newcommand{\middlemid}{\mathrel{}\middle|\mathrel{}}

\DeclareMathOperator{\E}{\mathbb{E}}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

\DeclareDocumentCommand{\ol}{ m }{
    {\mspace{1mu}\overline{\mspace{-1mu} #1 \mspace{-1mu}}\mspace{1mu}}
}
\DeclareDocumentCommand{\ul}{ m }{
    {\mspace{1mu}\underline{\mspace{-1mu} #1 \mspace{-1mu}}\mspace{1mu}}
}

\DeclareDocumentCommand{\abs}{ s m }{
    \IfBooleanTF{#1}{
        \lvert #2 \rvert
    }{
        \left\lvert #2 \right\rvert
    }
}
\DeclareDocumentCommand{\norm}{ s m }{
    \IfBooleanTF{#1}{
        \lVert #2 \rVert
    }{
        \left\lVert #2 \right\rVert
    }
}

\DeclareDocumentCommand{\qq}{ s m }{
    \IfBooleanTF{#1}{}{\quad} \text{#2} \quad
}

\usepackage{fixdif}
\letdif{\grad}{nabla}

\DeclareDocumentCommand\flatfrac{ m m }{ #1 / #2 }
\DeclareDocumentCommand\dd{}{\d}

\DeclareDocumentCommand\dv{ s o m g }{
    \IfBooleanTF{#1}{ \let\fractype\flatfrac }{ \let\fractype\frac }
    \IfNoValueTF{#4}{
        \fractype{
            \d \IfNoValueTF{#2}{}{^{#2}}
        }{
            \d #3\IfNoValueTF{#2}{}{^{#2}}
        }
    }{
        \fractype{
            \d \IfNoValueTF{#2}{}{^{#2}} #3
        }{
            \d #4\IfNoValueTF{#2}{}{^{#2}}
        }
    }
}

\DeclareDocumentCommand\pdv{ s o m g }{
    \IfBooleanTF{#1}{ \let\fractype\flatfrac }{ \let\fractype\frac }
    \IfNoValueTF{#4}{
        \fractype{
            \partial \IfNoValueTF{#2}{}{^{#2}}
        }{
            \partial #3\IfNoValueTF{#2}{}{^{#2}}
        }
    }{
        \fractype{
            \partial \IfNoValueTF{#2}{}{^{#2}} #3
        }{
            \partial #4\IfNoValueTF{#2}{}{^{#2}}
        }
    }
}

\DeclareDocumentCommand{\bb}{ s m }{
    \IfBooleanTF{#1}{ \symbfup{#2} }{ \symbfit{#2} }
}
\DeclareDocumentCommand{\mm}{}{\bb}
\DeclareDocumentCommand{\vv}{}{\bb}

% ----------------------------------------------------------------------------
% Bibliography
\usepackage[authordate, backend=biber]{biblatex-chicago}

% ----------------------------------------------------------------------------
% Fonts
\usepackage[
    math-style=ISO, bold-style=ISO,
    partial=upright,
    mathrm=sym, mathit=sym, mathsf=sym, mathbf=sym, mathtt=sym,
    warnings-off={mathtools-colon,mathtools-overbracket},
]{unicode-math}

\usepackage{pagella-otf}
\usepackage[scale=.8, nomap]{FiraMono}

\setmathfont{texgyrepagella-math.otf}[
    AutoFakeBold,
]

\setmathfont{NewCMMath-Book.otf}[
    AutoFakeBold,
    CharacterVariant=1,
    range={\mathop,\mathbin,\mathrel,\sqrt,\mathcal,\varnothing},
]

% ----------------------------------------------------------------------------
% Links
\usepackage[]{hyperref}
\hypersetup{
    allcolors = violet,
    breaklinks = true,
    colorlinks = true,
}

\usepackage{zref-clever}
\newcommand{\cref}[1]{\zcref[nameinlink=false, cap]{#1}}
\newcommand{\Cref}[1]{\zcref[nameinlink=false, cap]{#1}}
