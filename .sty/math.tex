\ifluatex
    \usepackage{lualatex-math}
\fi

\usepackage{xparse}

% -----------------------------------------------------------------------------
% Math macros

\newcommand{\opn}[1]{\operatorname{#1}}

\newcommand{\R}{\mathbb{R}}
\newcommand{\Z}{\mathbb{Z}}

\newcommand{\e}{\mathrm{e}}
\newcommand{\ii}{\mathrm{i}}
\newcommand{\ppi}{\mathrm{\pi}}

\newcommand{\middlemid}{\mathrel{}\middle|\mathrel{}}
% Inspired by <https://tex.stackexchange.com/a/431820>

\DeclareMathOperator{\E}{\mathbb{E}}
\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

% Make `\overline` and `\underline` shorter so that lines for consecutive
% letters do not connect
\DeclareDocumentCommand{\ol}{ m }{
    {\mspace{1mu}\overline{\mspace{-1mu} #1 \mspace{-1mu}}\mspace{1mu}}
}
\DeclareDocumentCommand{\ul}{ m }{
    {\mspace{1mu}\underline{\mspace{-1mu} #1 \mspace{-1mu}}\mspace{1mu}}
}
% Inspired by <https://tex.stackexchange.com/questions/281391/how-to-make-underline-shorter>
% (see comments of the question).

% -----------------------------------------------------------------------------
% Commands from `physics`

% The `physics` package breaks things. Some of the useful commands are
% adapted here, with the help of package `fixdif`.

\DeclareDocumentCommand{\abs}{ s m }{
    \IfBooleanTF{#1}{
        \left\lvert #2 \right\rvert
    }{
        \lvert #2 \rvert
    }
}
\DeclareDocumentCommand{\norm}{ s m }{
    \IfBooleanTF{#1}{
        \left\lVert #2 \right\rVert
    }{
        \lVert #2 \rVert
    }
}

\DeclareDocumentCommand{\qq}{ s m }{
    \IfBooleanTF{#1}{}{\quad} \text{#2} \quad
}

\usepackage{fixdif}
\letdif{\grad}{nabla}

\DeclareDocumentCommand\flatfrac{ m m }{ #1 / #2 }
\DeclareDocumentCommand\dd{}{\d}

\DeclareDocumentCommand\dv{ s o m g }{
    \IfBooleanTF{#1}{ \let\fractype\flatfrac }{ \let\fractype\frac }
    \IfNoValueTF{#4}{
        \fractype{
            \d \IfNoValueTF{#2}{}{^{#2}}
        }{
            \d #3\IfNoValueTF{#2}{}{^{#2}}
        }
    }{
        \fractype{
            \d \IfNoValueTF{#2}{}{^{#2}} #3
        }{
            \d #4\IfNoValueTF{#2}{}{^{#2}}
        }
    }
}

\DeclareDocumentCommand\pdv{ s o m g }{
    \IfBooleanTF{#1}{ \let\fractype\flatfrac }{ \let\fractype\frac }
    \IfNoValueTF{#4}{
        \fractype{
            \partial \IfNoValueTF{#2}{}{^{#2}}
        }{
            \partial #3\IfNoValueTF{#2}{}{^{#2}}
        }
    }{
        \fractype{
            \partial \IfNoValueTF{#2}{}{^{#2}} #3
        }{
            \partial #4\IfNoValueTF{#2}{}{^{#2}}
        }
    }
}

% -----------------------------------------------------------------------------
% Bold math

% There is, to my knowledge, no straightforward way to typeset bold math. The
% main issue is that font commands in `unicode-math` don't nest. This is a
% workaround. Use `\mm` and `\vv` for bold italic letters. Use `\mm*` and
% `\vv*` for bold upright letters.

\ifpdftex
    % If `unicode-math` is not loaded, which presumably only happens when
    % compiling with PDFTeX:
    \usepackage{bm}
    \DeclareDocumentCommand{\bb}{ s m }{
        \IfBooleanTF{#1}{ \bm{\mathrm{#2}} }{ \bm{#2} }
    }
\else
    % If `unicode-math` is loaded:
    \DeclareDocumentCommand{\bb}{ s m }{
        \IfBooleanTF{#1}{ \symbfup{#2} }{ \symbfit{#2} }
    }
\fi

\DeclareDocumentCommand{\mm}{}{\bb}
\DeclareDocumentCommand{\vv}{}{\bb}
